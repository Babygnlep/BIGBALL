<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIGBALL</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* ‚îÄ‚îÄ‚îÄ Reset & Root ‚îÄ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary:    #6366f1;
  --primary-lo: rgba(99,102,241,.18);
  --accent:     #06b6d4;
  --accent-lo:  rgba(6,182,212,.15);
  --success:    #34d399;
  --success-lo: rgba(52,211,153,.15);
  --warning:    #fbbf24;
  --warning-lo: rgba(251,191,36,.15);
  --danger:     #f87171;
  --danger-lo:  rgba(248,113,113,.15);

  --bg:         #0c1121;
  --surface:    #131d33;
  --surface-hi: #1a2744;
  --border:     rgba(148,163,184,.10);
  --border-hi:  rgba(148,163,184,.22);

  --text-1:     #f1f5f9;
  --text-2:     #94a3b8;
  --text-3:     #475569;

  --radius:     16px;
  --radius-sm:  10px;
  --radius-lg:  22px;
}

/* ‚îÄ‚îÄ‚îÄ Body & Background ‚îÄ‚îÄ‚îÄ */
body {
  font-family: 'Kanit', sans-serif;
  background: var(--bg);
  color: var(--text-1);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Ambient glow blobs */
body::before, body::after {
  content: '';
  position: fixed;
  border-radius: 50%;
  filter: blur(100px);
  opacity: .18;
  pointer-events: none;
  z-index: 0;
}
body::before {
  width: 380px; height: 380px;
  background: var(--primary);
  top: -120px; left: -100px;
}
body::after {
  width: 320px; height: 320px;
  background: var(--accent);
  bottom: -80px; right: -60px;
}

/* ‚îÄ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ‚îÄ */
.topbar {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  gap: 6px;
  padding: 10px 12px;
  background: rgba(19,29,51,.82);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
}

.topbar button {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  padding: 11px 6px;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-3);
  font-family: 'Kanit', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all .25s cubic-bezier(.4,0,.2,1);
}

.topbar button:hover {
  color: var(--text-2);
  background: var(--surface-hi);
}

.topbar button.active {
  color: var(--text-1);
  background: var(--primary-lo);
  border-color: rgba(99,102,241,.35);
  box-shadow: 0 0 14px rgba(99,102,241,.12);
}

.topbar button .tab-icon { font-size: 15px; }

/* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
.container {
  position: relative;
  z-index: 1;
  max-width: 480px;
  margin: 24px auto 40px;
  padding: 0 18px;
}

.page { display: none; animation: fadeUp .3s ease; }
.page.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ‚îÄ‚îÄ‚îÄ Section Header ‚îÄ‚îÄ‚îÄ */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding: 0 2px;
}

.section-header h4 {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--text-3);
}

.section-header .count-badge {
  font-size: 11px;
  font-weight: 500;
  color: var(--primary);
  background: var(--primary-lo);
  padding: 3px 9px;
  border-radius: 20px;
}

/* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
  transition: border-color .2s;
}
.card:hover { border-color: var(--border-hi); }

/* ‚îÄ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ‚îÄ */
.input-row { display: flex; gap: 8px; }
.input-row input { flex: 1; }
.input-row input:last-child { flex: .45; }

input {
  display: block;
  width: 100%;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--surface-hi);
  color: var(--text-1);
  font-family: 'Kanit', sans-serif;
  font-size: 14px;
  font-weight: 400;
  margin-bottom: 10px;
  transition: border-color .2s, box-shadow .2s;
  outline: none;
}

input::placeholder { color: var(--text-3); }

input:focus {
  border-color: rgba(99,102,241,.5);
  box-shadow: 0 0 0 3px rgba(99,102,241,.12);
}

input[type="date"] { color-scheme: dark; }

/* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
button.main {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 100%;
  padding: 13px;
  border-radius: var(--radius);
  border: none;
  background: linear-gradient(135deg, var(--primary), #818cf8);
  color: #fff;
  font-family: 'Kanit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: transform .15s, box-shadow .2s, opacity .2s;
  box-shadow: 0 4px 18px rgba(99,102,241,.3);
  margin-top: 4px;
}

button.main:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 24px rgba(99,102,241,.4);
}

button.main:active { transform: translateY(0); }

button.main.secondary {
  background: var(--surface-hi);
  box-shadow: none;
  color: var(--text-2);
  font-weight: 500;
}
button.main.secondary:hover {
  background: var(--border-hi);
  box-shadow: none;
  color: var(--text-1);
}

button.main.danger {
  background: linear-gradient(135deg, var(--danger), #fb7185);
  box-shadow: 0 4px 18px rgba(248,113,113,.25);
}
button.main.danger:hover {
  box-shadow: 0 6px 24px rgba(248,113,113,.35);
}

button.main.success {
  background: linear-gradient(135deg, var(--success), #6ee7b7);
  box-shadow: 0 4px 18px rgba(52,211,153,.25);
  color: #064e3b;
}
button.main.success:hover {
  box-shadow: 0 6px 24px rgba(52,211,153,.35);
}

/* ‚îÄ‚îÄ‚îÄ Stock Item Row ‚îÄ‚îÄ‚îÄ */
.stock-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface-hi);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 11px 14px;
  margin-bottom: 8px;
  transition: border-color .2s;
  animation: slideIn .22s ease both;
}
.stock-item:hover { border-color: var(--border-hi); }

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-8px); }
  to   { opacity: 1; transform: translateX(0); }
}

.stock-item .item-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.stock-item .item-icon {
  width: 34px; height: 34px;
  border-radius: 9px;
  background: var(--primary-lo);
  color: var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
}

.stock-item .item-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-1);
}

.stock-item .item-qty {
  font-size: 12px;
  color: var(--text-3);
  margin-top: 1px;
}

/* ‚îÄ‚îÄ‚îÄ Qty Controls ‚îÄ‚îÄ‚îÄ */
.controls {
  display: flex;
  align-items: center;
  gap: 6px;
}

.controls button {
  width: 32px; height: 32px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 17px;
  line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
  background: var(--surface);
  color: var(--text-2);
}

.controls button:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-lo);
}

.controls .qty-val {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
  min-width: 22px;
  text-align: center;
  font-family: 'IBM Plex Mono', monospace;
}

/* ‚îÄ‚îÄ‚îÄ Out page qty input + button ‚îÄ‚îÄ‚îÄ */
.out-qty-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
}

.out-qty-input {
  width: 52px;
  height: 34px;
  padding: 0 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface-hi);
  color: var(--text-1);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
  margin-bottom: 0;
}
.out-qty-input:focus {
  border-color: rgba(99,102,241,.5);
  box-shadow: 0 0 0 3px rgba(99,102,241,.12);
}
.out-qty-input::placeholder { color: var(--text-3); font-size: 11px; font-family: 'Kanit'; }

/* hide default number input arrows */
.out-qty-input::-webkit-outer-spin-button,
.out-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.out-qty-input[type=number] { -moz-appearance: textfield; }

.add-out-btn {
  height: 34px;
  padding: 0 12px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(135deg, var(--primary), #818cf8);
  color: #fff;
  font-family: 'Kanit', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s, box-shadow .2s;
  box-shadow: 0 3px 12px rgba(99,102,241,.35);
  white-space: nowrap;
}
.add-out-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 16px rgba(99,102,241,.45);
}

.remove-out-btn {
  width: 30px; height: 30px;
  border-radius: 8px;
  border: 1px solid var(--danger-lo);
  background: var(--danger-lo);
  color: var(--danger);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s;
}
.remove-out-btn:hover { background: rgba(248,113,113,.28); }

/* ‚îÄ‚îÄ‚îÄ Bill Cards ‚îÄ‚îÄ‚îÄ */
.bill-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 14px;
  transition: border-color .2s;
  animation: slideIn .22s ease both;
}
.bill-card:hover { border-color: var(--border-hi); }

.bill-card .bill-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 10px;
}

.bill-card .bill-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-1);
}

.bill-card .bill-meta {
  font-size: 12px;
  color: var(--text-3);
  margin-top: 3px;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 11px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .03em;
}

.badge.pending { background: var(--warning-lo); color: var(--warning); }
.badge.paid    { background: var(--success-lo); color: var(--success); }

.bill-price {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-1);
  font-family: 'IBM Plex Mono', monospace;
  margin-bottom: 12px;
}
.bill-price span { font-size: 13px; color: var(--text-3); font-weight: 400; font-family: 'Kanit'; }

.bill-actions { display: flex; gap: 8px; }
.bill-actions button { flex: 1; }

/* ‚îÄ‚îÄ‚îÄ Bill Items List (small) ‚îÄ‚îÄ‚îÄ */
.bill-items-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 14px;
}

.bill-items-list .tag {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-2);
  background: var(--surface-hi);
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
}

/* ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  color: var(--text-3);
  padding: 32px 0;
  font-size: 14px;
}
.empty-state .empty-icon {
  font-size: 28px;
  margin-bottom: 8px;
  opacity: .5;
}

/* ‚îÄ‚îÄ‚îÄ Clear Paid Row ‚îÄ‚îÄ‚îÄ */
.clear-paid-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--danger-lo);
  border: 1px solid rgba(248,113,113,.2);
  border-radius: var(--radius);
  padding: 10px 14px;
  margin-bottom: 20px;
  animation: fadeUp .25s ease;
}

.clear-paid-row .clear-label {
  font-size: 13px;
  color: var(--danger);
  font-weight: 500;
}

.clear-paid-row .clear-label span {
  color: var(--text-3);
  font-size: 11px;
  font-weight: 400;
  display: block;
  margin-top: 2px;
}

.clear-paid-row button {
  padding: 7px 14px;
  border-radius: 9px;
  border: 1px solid rgba(248,113,113,.35);
  background: rgba(248,113,113,.12);
  color: var(--danger);
  font-family: 'Kanit', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background .18s, border-color .18s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 5px;
}

.clear-paid-row button:hover {
  background: rgba(248,113,113,.22);
  border-color: rgba(248,113,113,.5);
}

/* auto-delete notice */
.auto-del-notice {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  background: var(--surface-hi);
  border: 1px solid var(--border);
  margin-bottom: 18px;
  animation: fadeUp .25s ease;
}

.auto-del-notice .ad-icon { font-size: 14px; opacity:.6; }

.auto-del-notice .ad-text {
  font-size: 11.5px;
  color: var(--text-3);
  line-height: 1.45;
}

.auto-del-notice .ad-text strong { color: var(--text-2); font-weight: 600; }

.controls button.del-btn {
  width: 30px;
  height: 30px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-3);
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .15s;
  margin-left: 4px;
}

.controls button.del-btn:hover {
  border-color: rgba(248,113,113,.4);
  background: var(--danger-lo);
  color: var(--danger);
}

/* ‚îÄ‚îÄ‚îÄ Stock Category Section Title ‚îÄ‚îÄ‚îÄ */
.cat-section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
  margin-bottom: 10px;
}
.cat-section-title:first-child { margin-top: 0; }

.cat-section-title .cat-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-2);
  text-transform: uppercase;
  letter-spacing: .06em;
  white-space: nowrap;
}

.cat-section-title .cat-line {
  flex: 1;
  height: 1px;
  background: var(--border);
}

.cat-section-title .cat-count {
  font-size: 11px;
  color: var(--text-3);
  white-space: nowrap;
}

/* ‚îÄ‚îÄ‚îÄ Overdue Warning Banner ‚îÄ‚îÄ‚îÄ */
.overdue-banner {
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, rgba(248,113,113,.15), rgba(251,191,36,.1));
  border: 1px solid rgba(248,113,113,.25);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 20px;
  animation: fadeUp .25s ease;
}

.overdue-banner-left {
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.overdue-icon { font-size: 22px; line-height: 1.2; }

.overdue-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--danger);
}

.overdue-sub {
  font-size: 12px;
  color: var(--text-3);
  margin-top: 2px;
}

/* ‚îÄ‚îÄ‚îÄ Recall Card ‚îÄ‚îÄ‚îÄ */
.recall-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  margin-bottom: 14px;
  transition: border-color .2s;
  animation: slideIn .22s ease both;
}
.recall-card:hover { border-color: var(--border-hi); }
.recall-card.overdue-card { border-color: rgba(248,113,113,.3); }

.recall-card .recall-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 12px;
}

.recall-card .recall-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-1);
}

.recall-card .recall-date {
  font-size: 12px;
  color: var(--text-3);
  margin-top: 2px;
}

.overdue-days {
  font-size: 11px;
  font-weight: 700;
  color: var(--danger);
  background: var(--danger-lo);
  border: 1px solid rgba(248,113,113,.2);
  padding: 3px 9px;
  border-radius: 14px;
  white-space: nowrap;
}

.ok-days {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-3);
  background: var(--surface-hi);
  border: 1px solid var(--border);
  padding: 3px 9px;
  border-radius: 14px;
  white-space: nowrap;
}

/* ‚îÄ‚îÄ‚îÄ Return Item Row ‚îÄ‚îÄ‚îÄ */
.return-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface-hi);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 9px 12px;
  margin-bottom: 7px;
  transition: border-color .18s;
}
.return-item:hover { border-color: var(--border-hi); }

.return-item .ri-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.return-item .ri-icon {
  width: 30px; height: 30px;
  border-radius: 8px;
  background: var(--accent-lo);
  color: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}

.return-item .ri-name { font-size: 13px; font-weight: 500; color: var(--text-1); }
.return-item .ri-qty { font-size: 11px; color: var(--text-3); margin-top: 1px; }

.return-item .ri-controls {
  display: flex;
  align-items: center;
  gap: 6px;
}

.return-item .ri-controls button {
  width: 28px; height: 28px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-2);
  font-size: 15px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
  font-family: 'Kanit';
}

.return-item .ri-controls button:hover {
  border-color: var(--success);
  color: var(--success);
  background: var(--success-lo);
}

.return-item .ri-controls .ri-val {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-1);
  min-width: 18px;
  text-align: center;
  font-family: 'IBM Plex Mono', monospace;
}

.return-item .ri-controls button.ri-done {
  width: auto;
  padding: 5px 10px;
  border-radius: 7px;
  border-color: rgba(52,211,153,.3);
  background: var(--success-lo);
  color: var(--success);
  font-size: 11px;
  font-weight: 600;
  gap: 3px;
}
.return-item .ri-controls button.ri-done:hover {
  background: rgba(52,211,153,.25);
  border-color: rgba(52,211,153,.5);
  color: var(--success);
}

/* ‚îÄ‚îÄ‚îÄ Bill Filter Tabs ‚îÄ‚îÄ‚îÄ */
.filter-row {
  display: flex;
  gap: 6px;
  margin-bottom: 22px;
  flex-wrap: wrap;
}

.filter-row button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 24px;
  border: 1px solid var(--border);
  background: var(--surface-hi);
  color: var(--text-3);
  font-family: 'Kanit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s cubic-bezier(.4,0,.2,1);
}

.filter-row button:hover { color: var(--text-2); border-color: var(--border-hi); }

.filter-row button .filter-count {
  font-size: 11px;
  font-weight: 600;
  background: rgba(0,0,0,.25);
  padding: 1px 7px;
  border-radius: 10px;
  min-width: 20px;
  text-align: center;
}

/* Active states per filter */
.filter-row button.active-filter { border-color: transparent; }

.filter-row button[data-filter="all"].active-filter {
  background: var(--primary-lo);
  color: var(--primary);
  border-color: rgba(99,102,241,.3);
}
.filter-row button[data-filter="all"].active-filter .filter-count { background: rgba(99,102,241,.3); }

.filter-row button[data-filter="pending"].active-filter {
  background: var(--accent-lo);
  color: var(--accent);
  border-color: rgba(6,182,212,.3);
}
.filter-row button[data-filter="pending"].active-filter .filter-count { background: rgba(6,182,212,.3); }

.filter-row button[data-filter="deposit"].active-filter {
  background: var(--warning-lo);
  color: var(--warning);
  border-color: rgba(251,191,36,.3);
}
.filter-row button[data-filter="deposit"].active-filter .filter-count { background: rgba(251,191,36,.3); }

.filter-row button[data-filter="paid"].active-filter {
  background: var(--success-lo);
  color: var(--success);
  border-color: rgba(52,211,153,.3);
}
.filter-row button[data-filter="paid"].active-filter .filter-count { background: rgba(52,211,153,.3); }

/* ‚îÄ‚îÄ‚îÄ Payment Type Selector ‚îÄ‚îÄ‚îÄ */
.pay-type-row {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  background: var(--surface-hi);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 5px;
}

.pay-type-row button {
  flex: 1;
  padding: 9px 6px;
  border: 1px solid transparent;
  border-radius: 11px;
  background: transparent;
  color: var(--text-3);
  font-family: 'Kanit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s cubic-bezier(.4,0,.2,1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}

.pay-type-row button:hover { color: var(--text-2); }

.pay-type-row button.active-pay {
  color: var(--text-1);
  background: var(--surface);
  border-color: var(--border-hi);
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}

.pay-type-row button[data-type="paid"].active-pay {
  color: var(--success);
  border-color: rgba(52,211,153,.3);
  background: var(--success-lo);
}

.pay-type-row button[data-type="deposit"].active-pay {
  color: var(--warning);
  border-color: rgba(251,191,36,.3);
  background: var(--warning-lo);
}

.pay-type-row button[data-type="pending"].active-pay {
  color: var(--accent);
  border-color: rgba(6,182,212,.3);
  background: var(--accent-lo);
}

/* Deposit detail row */
.deposit-row {
  display: flex;
  gap: 8px;
  align-items: center;
  background: var(--warning-lo);
  border: 1px solid rgba(251,191,36,.2);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 10px;
  animation: fadeUp .2s ease;
}

.deposit-row .dep-label {
  font-size: 12px;
  color: var(--warning);
  font-weight: 600;
  white-space: nowrap;
  min-width: 60px;
}

.deposit-row input {
  margin-bottom: 0;
  flex: 1;
  padding: 8px 12px;
  font-size: 14px;
  background: var(--surface);
  border-color: rgba(251,191,36,.25);
}

.deposit-row input:focus {
  border-color: rgba(251,191,36,.5);
  box-shadow: 0 0 0 3px rgba(251,191,36,.1);
}

.deposit-row .dep-remaining {
  font-size: 12px;
  color: var(--warning);
  white-space: nowrap;
  font-weight: 500;
  min-width: 75px;
  text-align: right;
}

/* Badge ‚Äî deposit */
.badge.deposit { background: var(--warning-lo); color: var(--warning); }
.badge.invoiced { background: var(--accent-lo); color: var(--accent); }

/* ‚îÄ‚îÄ‚îÄ Bill action row buttons small ‚îÄ‚îÄ‚îÄ */
.btn-row { display: flex; gap: 8px; margin-top: 10px; }
.btn-row button { flex: 1; }

/* ‚îÄ‚îÄ‚îÄ Edit Item Row in Edit Page ‚îÄ‚îÄ‚îÄ */
.edit-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface-hi);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 11px 14px;
  margin-bottom: 8px;
  transition: border-color .2s;
  animation: slideIn .22s ease both;
}
.edit-item:hover { border-color: var(--border-hi); }

.edit-item .item-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.edit-item .item-icon {
  width: 34px; height: 34px;
  border-radius: 9px;
  background: var(--warning-lo);
  color: var(--warning);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
}

.edit-item .item-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-1);
}

.edit-controls {
  display: flex;
  align-items: center;
  gap: 6px;
}

.edit-controls button {
  width: 32px; height: 32px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 17px;
  line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
  background: var(--surface);
  color: var(--text-2);
}

.edit-controls button:hover {
  border-color: var(--warning);
  color: var(--warning);
  background: var(--warning-lo);
}

.edit-controls .qty-val {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
  min-width: 22px;
  text-align: center;
  font-family: 'IBM Plex Mono', monospace;
}

.edit-controls button.remove-edit-item {
  border-color: var(--danger-lo);
  background: var(--danger-lo);
  color: var(--danger);
}
.edit-controls button.remove-edit-item:hover {
  background: rgba(248,113,113,.28);
  border-color: rgba(248,113,113,.4);
}

/* Back button */
.back-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--surface-hi);
  color: var(--text-2);
  font-family: 'Kanit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s;
  margin-bottom: 16px;
}
.back-btn:hover {
  background: var(--border-hi);
  color: var(--text-1);
}

/* ‚îÄ‚îÄ‚îÄ Preview Page Styles ‚îÄ‚îÄ‚îÄ */
.preview-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin-bottom: 20px;
  animation: fadeUp .3s ease;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
}

.ph-left { display: flex; flex-direction: column; gap: 8px; }

.ph-logo {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-1);
  line-height: 1.1;
}

.ph-company {
  font-size: 11px;
  color: var(--text-3);
}

.ph-right { text-align: right; }

.ph-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--warning);
  margin-bottom: 12px;
}

.ph-info { display: flex; flex-direction: column; gap: 4px; }

.phi-row {
  font-size: 12px;
  color: var(--text-3);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.phi-row strong { color: var(--text-1); }

.preview-customer {
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}

.pc-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--warning);
  text-transform: uppercase;
  letter-spacing: .05em;
  margin-bottom: 4px;
}

.pc-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-1);
}

.preview-items {
  margin-bottom: 20px;
}

.preview-item-header {
  display: flex;
  gap: 12px;
  padding: 10px 12px;
  background: var(--surface-hi);
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-3);
  text-transform: uppercase;
  letter-spacing: .04em;
  margin-bottom: 8px;
}

.preview-item {
  display: flex;
  gap: 12px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  align-items: center;
}

.pi-num {
  width: 40px;
  font-size: 12px;
  color: var(--text-3);
  text-align: center;
}

.pi-name {
  flex: 1;
  font-size: 13px;
  color: var(--text-1);
}

.pi-qty {
  width: 80px;
  font-size: 13px;
  color: var(--text-2);
  text-align: right;
  font-family: 'IBM Plex Mono', monospace;
}

.preview-totals {
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.preview-total-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  font-size: 13px;
}

.preview-total-row.sub {
  font-size: 12px;
  color: var(--text-3);
}

.pt-label {
  color: var(--text-3);
  font-weight: 500;
}

.preview-total-row.sub .pt-label {
  padding-left: 20px;
}

.pt-value {
  color: var(--text-1);
  font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}

.preview-grand {
  display: flex;
  justify-content: space-between;
  padding: 12px;
  margin-top: 8px;
  background: var(--warning-lo);
  border-radius: var(--radius-sm);
  border: 1px solid rgba(251,191,36,.2);
}

.pg-label {
  font-size: 14px;
  font-weight: 700;
  color: var(--warning);
}

.pg-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-1);
  font-family: 'IBM Plex Mono', monospace;
}
</style>
</head>
<body>

<div id="main-app">

  <div class="topbar">
    <button onclick="showPage('stock')" class="active">
      <span class="tab-icon">üì¶</span> ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
    </button>
    <button onclick="showPage('out')">
      <span class="tab-icon">üöö</span> ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏Å
    </button>
    <button onclick="showPage('recall')">
      <span class="tab-icon">üîÑ</span> ‡∏Ñ‡∏∑‡∏ô <span id="recallBadge" style="display:none;background:var(--danger);color:#fff;font-size:10px;padding:1px 6px;border-radius:10px;font-weight:700;">0</span>
    </button>
    <button onclick="showPage('bill')">
      <span class="tab-icon">üßæ</span> ‡∏ö‡∏¥‡∏•
    </button>
  </div>

  <div class="container">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STOCK PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-stock" class="page active">

      <div class="card">
        <div class="section-header"><h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4></div>
        <div class="input-row">
          <input id="newItemName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          <input id="newItemQty" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1">
        </div>
        <input id="newItemCat" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" list="catList">
        <datalist id="catList"></datalist>
        <button class="main" onclick="addStock()">
          <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
      </div>

      <div class="section-header">
        <h4>‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
        <span class="count-badge" id="stockCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
      <div id="stockList"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OUT PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-out" class="page">

      <div class="card">
        <div class="section-header"><h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•</h4></div>
        <input id="billName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
        <div class="input-row">
          <input id="billDate" type="date">
          <input id="billPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ö‡∏≤‡∏ó">
        </div>
      </div>

      <div class="card">
        <div class="section-header"><h4>‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢</h4></div>
        <div class="pay-type-row">
          <button data-type="pending" class="active-pay" onclick="setPayType('pending')">üìã ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•</button>
          <button data-type="deposit" onclick="setPayType('deposit')">üí∞ ‡∏°‡∏±‡∏î‡∏à‡∏≥</button>
          <button data-type="paid" onclick="setPayType('paid')">‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢</button>
        </div>
        <div id="depositDetail" style="display:none;">
          <div class="deposit-row">
            <span class="dep-label">‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            <input type="number" id="depositAmt" placeholder="0" oninput="render()">
            <span class="dep-remaining" id="depRemaining">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0</span>
          </div>
        </div>
      </div>

      <div class="section-header">
        <h4>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
      </div>
      <div id="outStock" style="margin-bottom:18px;"></div>
      <div class="section-header">
        <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</h4>
        <span class="count-badge" id="outCount">0</span>
      </div>
      <div id="outBill"></div>

      <button class="main" onclick="confirmBill()" style="margin-top:8px;">
        <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏¥‡∏•
      </button>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECALL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-recall" class="page" style="padding-top:10px;">

      <div id="overdueWarning" style="display:none;">
        <div class="overdue-banner">
          <div class="overdue-banner-left">
            <span class="overdue-icon">‚ö†Ô∏è</span>
            <div>
              <div class="overdue-title">‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤!</div>
              <div class="overdue-sub" id="overdueSubText"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="recallList"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BILL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-bill" class="page" style="padding-top:10px;">

      <div class="filter-row">
        <button data-filter="all" class="active-filter" onclick="setBillFilter('all')">
          üìä ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="filter-count" id="fc-all">0</span>
        </button>
        <button data-filter="pending" onclick="setBillFilter('pending')">
          üìã ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏• <span class="filter-count" id="fc-pending">0</span>
        </button>
        <button data-filter="deposit" onclick="setBillFilter('deposit')">
          üí∞ ‡∏°‡∏±‡∏î‡∏à‡∏≥ <span class="filter-count" id="fc-deposit">0</span>
        </button>
        <button data-filter="paid" onclick="setBillFilter('paid')">
          ‚úì ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß <span class="filter-count" id="fc-paid">0</span>
        </button>
      </div>

      <div class="auto-del-notice">
        <span class="ad-icon">üïê</span>
        <div class="ad-text">‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà <strong>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</strong> ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á <strong>1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</strong></div>
      </div>

      <div id="clearPaidRow" style="display:none;">
        <div class="clear-paid-row">
          <div class="clear-label">
            ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            <span id="clearPaidCount"></span>
          </div>
          <button onclick="clearAllPaid()"><i class="fas fa-trash"></i> ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>

      <div id="billList"></div>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PREVIEW PDF PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-preview" class="page" style="padding-top:10px;">
      
      <button class="back-btn" onclick="cancelPreview()">
        <i class="fas fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </button>

      <div class="preview-card">
        <div id="previewContent"></div>
      </div>

      <div class="btn-row">
        <button class="main secondary" onclick="cancelPreview()">
          <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button class="main" onclick="editBeforePrint()" style="background:linear-gradient(135deg,var(--warning),#fcd34d);color:#78350f;">
          <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•
        </button>
      </div>
      
      <button class="main success" onclick="printPDF()" style="margin-top:8px;">
        <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå PDF
      </button>
    </section>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT BILL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <section id="page-edit" class="page" style="padding-top:10px;">
      
      <button class="back-btn" onclick="cancelEdit()">
        <i class="fas fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </button>

      <div class="card">
        <div class="section-header"><h4>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•</h4></div>
        <input id="editBillName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
        <div class="input-row">
          <input id="editBillDate" type="date">
          <input id="editBillPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ö‡∏≤‡∏ó" oninput="renderEdit()">
        </div>
      </div>

      <div class="card">
        <div class="section-header"><h4>‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢</h4></div>
        <div class="pay-type-row">
          <button data-type="pending" class="active-pay" onclick="setEditPayType('pending')">üìã ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•</button>
          <button data-type="deposit" onclick="setEditPayType('deposit')">üí∞ ‡∏°‡∏±‡∏î‡∏à‡∏≥</button>
          <button data-type="paid" onclick="setEditPayType('paid')">‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢</button>
        </div>
        <div id="editDepositDetail" style="display:none;">
          <div class="deposit-row">
            <span class="dep-label">‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
            <input type="number" id="editDepositAmt" placeholder="0" oninput="renderEdit()">
            <span class="dep-remaining" id="editDepRemaining">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0</span>
          </div>
        </div>
      </div>

      <div class="section-header">
        <h4>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</h4>
        <span class="count-badge" id="editItemCount">0</span>
      </div>
      <div id="editItemsList"></div>

      <div class="section-header" style="margin-top:20px;">
        <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
      </div>
      <div id="editAddStock"></div>

      <div class="btn-row" style="margin-top:20px;">
        <button class="main secondary" onclick="cancelEdit()">
          <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button class="main" onclick="saveEdit()">
          <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    </section>

  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let items = JSON.parse(localStorage.getItem('items')) || [];
let bills = JSON.parse(localStorage.getItem('bills')) || [];
let outItems = [];
let currentPayType = 'pending'; // pending | deposit | paid
let billFilter = 'all';         // all | pending | deposit | paid

// Edit mode state
let editingBillIndex = null;
let editPayType = 'pending';
let editItems = [];

document.getElementById('billDate').value = new Date().toISOString().split('T')[0];

// ‚îÄ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ
function save() {
  localStorage.setItem('items', JSON.stringify(items));
  localStorage.setItem('bills', JSON.stringify(bills));
}

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.topbar button').forEach(x => x.classList.remove('active'));
  const map = { stock: 0, out: 1, recall: 2, bill: 3 };
  document.getElementById('page-' + p).classList.add('active');
  if (map[p] !== undefined) {
    document.querySelectorAll('.topbar button')[map[p]].classList.add('active');
  }
}

// ‚îÄ‚îÄ‚îÄ Pay Type ‚îÄ‚îÄ‚îÄ
function setPayType(type) {
  currentPayType = type;
  document.querySelectorAll('.pay-type-row button').forEach(b => b.classList.remove('active-pay'));
  document.querySelector(`.pay-type-row button[data-type="${type}"]`).classList.add('active-pay');
  document.getElementById('depositDetail').style.display = (type === 'deposit') ? 'block' : 'none';
  if (type !== 'deposit') document.getElementById('depositAmt').value = '';
  render();
}

// ‚îÄ‚îÄ‚îÄ Bill Filter ‚îÄ‚îÄ‚îÄ
function setBillFilter(f) {
  billFilter = f;
  document.querySelectorAll('.filter-row button').forEach(b => b.classList.remove('active-filter'));
  document.querySelector(`.filter-row button[data-filter="${f}"]`).classList.add('active-filter');
  render();
}

// ‚îÄ‚îÄ‚îÄ Stock ‚îÄ‚îÄ‚îÄ
function addStock() {
  const n = document.getElementById('newItemName').value.trim();
  const q = Number(document.getElementById('newItemQty').value);
  const cat = document.getElementById('newItemCat').value.trim();
  if (!n || q <= 0) return;
  const existing = items.find(i => i.name === n);
  if (existing) {
    existing.qty += q;
    if (cat) existing.category = cat;
  } else {
    items.push({ name: n, qty: q, category: cat || '' });
  }
  document.getElementById('newItemName').value = '';
  document.getElementById('newItemQty').value = '';
  document.getElementById('newItemCat').value = '';
  save(); render();
}

// ‚îÄ‚îÄ‚îÄ ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚îÄ‚îÄ‚îÄ
function deleteItem(i) {
  if (!confirm(`‡∏•‡∏ö "${items[i].name}" ‡∏≠‡∏≠‡∏Å?`)) return;
  items.splice(i, 1);
  save(); render();
}

// ‚îÄ‚îÄ‚îÄ Out ‚îÄ‚îÄ‚îÄ
function addOutByQty(i) {
  const input = document.getElementById('outQty_' + i);
  let qty = Number(input.value) || 1;
  if (qty <= 0) qty = 1;
  if (qty > items[i].qty) qty = items[i].qty;
  if (items[i].qty <= 0) return;

  items[i].qty -= qty;
  const b = outItems.find(x => x.name === items[i].name);
  b ? b.qty += qty : outItems.push({ name: items[i].name, qty: qty });

  input.value = '';
  save(); render();
}

function removeOut(i) {
  const b = outItems[i];
  const it = items.find(x => x.name === b.name);
  if (it) it.qty++;
  b.qty--;
  if (b.qty <= 0) outItems.splice(i, 1);
  save(); render();
}

function confirmBill() {
  if (!outItems.length) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•'); return; }
  const price = Number(document.getElementById('billPrice').value) || 0;
  const deposit = (currentPayType === 'deposit') ? (Number(document.getElementById('depositAmt').value) || 0) : 0;

  bills.push({
    billName: document.getElementById('billName').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    date: document.getElementById('billDate').value,
    price: price,
    payType: currentPayType,
    deposit: deposit,
    remaining: (currentPayType === 'deposit') ? Math.max(price - deposit, 0) : (currentPayType === 'paid' ? 0 : price),
    status: currentPayType === 'paid' ? 'paid' : 'pending',
    items: JSON.parse(JSON.stringify(outItems))
  });

  outItems = [];
  document.getElementById('billName').value = '';
  document.getElementById('billPrice').value = '';
  document.getElementById('depositAmt').value = '';
  setPayType('pending');
  save(); render(); showPage('bill');
}

// ‚îÄ‚îÄ‚îÄ Bill Actions ‚îÄ‚îÄ‚îÄ
function markPaid(i) {
  bills[i].items.forEach(b => {
    const it = items.find(x => x.name === b.name);
    if (it) it.qty += b.qty;
  });
  bills[i].status = 'paid';
  bills[i].remaining = 0;
  bills[i].paidAt = Date.now();
  save(); render();
}

function clearBill(i) {
  bills[i].items.forEach(b => {
    const it = items.find(x => x.name === b.name);
    if (it) it.qty += b.qty;
  });
  bills.splice(i, 1);
  save(); render();
}

// ‚îÄ‚îÄ‚îÄ Auto-delete ‡∏ö‡∏¥‡∏•‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô ‚îÄ‚îÄ‚îÄ
function autoCleanup() {
  const ONE_MONTH = 30 * 24 * 60 * 60 * 1000;
  const now = Date.now();
  const before = bills.length;
  bills = bills.filter(b => {
    if (b.status === 'paid' && b.paidAt && (now - b.paidAt) > ONE_MONTH) return false;
    return true;
  });
  if (bills.length !== before) { save(); }
}

// ‚îÄ‚îÄ‚îÄ ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≤‡∏¢‡∏ö‡∏¥‡∏• ‚îÄ‚îÄ‚îÄ
function deletePaidBill(i) {
  bills.splice(i, 1);
  save(); render();
}

// ‚îÄ‚îÄ‚îÄ ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (manual) ‚îÄ‚îÄ‚îÄ
function clearAllPaid() {
  const cnt = bills.filter(b => b.status === 'paid').length;
  if (!cnt) return;
  if (!confirm(`‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cnt} ‡∏ö‡∏¥‡∏•?`)) return;
  bills = bills.filter(b => b.status !== 'paid');
  save(); render();
}

// ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô ‚îÄ‚îÄ‚îÄ
const OVERDUE_DAYS = 7;

function getDaysSince(dateStr) {
  const d = new Date(dateStr);
  const now = new Date();
  return Math.floor((now - d) / (1000 * 60 * 60 * 24));
}

function returnItem(billIdx, itemName) {
  const bill = bills[billIdx];
  const item = bill.items.find(x => x.name === itemName);
  if (!item || item.qty <= 0) return;

  const stock = items.find(x => x.name === itemName);
  if (stock) stock.qty++;

  item.qty--;
  bill.items = bill.items.filter(x => x.qty > 0);

  if (bill.items.length === 0) {
    bill.status = 'paid';
    bill.remaining = 0;
    bill.paidAt = Date.now();
  }

  save(); render(); renderRecall();
}

function renderRecall() {
  const pending = bills
    .map((b, i) => ({ ...b, idx: i }))
    .filter(b => b.status === 'pending');

  const overdue = pending.filter(b => getDaysSince(b.date) > OVERDUE_DAYS);

  const banner = document.getElementById('overdueWarning');
  if (overdue.length > 0) {
    banner.style.display = 'block';
    document.getElementById('overdueSubText').textContent =
      overdue.length + ' ‡∏ö‡∏¥‡∏• ‡πÄ‡∏Å‡∏¥‡∏ô ' + OVERDUE_DAYS + ' ‡∏ß‡∏±‡∏ô ‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô';
  } else {
    banner.style.display = 'none';
  }

  const badge = document.getElementById('recallBadge');
  if (overdue.length > 0) {
    badge.style.display = 'inline-block';
    badge.textContent = overdue.length;
  } else {
    badge.style.display = 'none';
  }

  document.getElementById('recallList').innerHTML = pending.length
    ? pending.map((b, ri) => {
        const days = getDaysSince(b.date);
        const isOver = days > OVERDUE_DAYS;
        return `
        <div class="recall-card ${isOver ? 'overdue-card' : ''}" style="animation-delay:${ri*.05}s">
          <div class="recall-header">
            <div>
              <div class="recall-name">${b.billName}</div>
              <div class="recall-date">‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ${b.date}</div>
            </div>
            <span class="${isOver ? 'overdue-days' : 'ok-days'}">${isOver ? '‚ö° ‡πÄ‡∏Å‡∏¥‡∏ô ' + days + ' ‡∏ß‡∏±‡∏ô' : days + ' ‡∏ß‡∏±‡∏ô'}</span>
          </div>
          <div>
            ${b.items.map(it => `
              <div class="return-item">
                <div class="ri-left">
                  <div class="ri-icon">üì¶</div>
                  <div>
                    <div class="ri-name">${it.name}</div>
                    <div class="ri-qty">‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                  </div>
                </div>
                <div class="ri-controls">
                  <button onclick="returnItem(${b.idx}, '${it.name}')" class="ri-done">‚Ü© ‡∏Ñ‡∏∑‡∏ô</button>
                </div>
              </div>`).join('')}
          </div>
        </div>`;
      }).join('')
    : `<div class="empty-state"><div class="empty-icon">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</div>`;
}

function getBadgeHTML(bill) {
  if (bill.status === 'paid') return `<span class="badge paid">‚úì ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
  if (bill.payType === 'deposit') return `<span class="badge deposit">üí∞ ‡∏°‡∏±‡∏î‡∏à‡∏≥</span>`;
  return `<span class="badge invoiced">üìã ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•</span>`;
}

// ‚îÄ‚îÄ‚îÄ EDIT BILL FUNCTIONS ‚îÄ‚îÄ‚îÄ
function startEdit(billIdx) {
  const bill = bills[billIdx];
  if (bill.status === 'paid') {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    return;
  }

  editingBillIndex = billIdx;
  editPayType = bill.payType;
  editItems = JSON.parse(JSON.stringify(bill.items));

  document.getElementById('editBillName').value = bill.billName;
  document.getElementById('editBillDate').value = bill.date;
  document.getElementById('editBillPrice').value = bill.price;
  document.getElementById('editDepositAmt').value = bill.deposit || '';

  setEditPayType(editPayType);
  renderEdit();
  showPage('edit');
}

function setEditPayType(type) {
  editPayType = type;
  document.querySelectorAll('#page-edit .pay-type-row button').forEach(b => b.classList.remove('active-pay'));
  document.querySelector(`#page-edit .pay-type-row button[data-type="${type}"]`).classList.add('active-pay');
  document.getElementById('editDepositDetail').style.display = (type === 'deposit') ? 'block' : 'none';
  if (type !== 'deposit') document.getElementById('editDepositAmt').value = '';
  renderEdit();
}

function editItemQtyChange(itemName, delta) {
  const item = editItems.find(x => x.name === itemName);
  if (!item) return;
  
  const stock = items.find(x => x.name === itemName);
  
  if (delta > 0) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ stock ‡∏û‡∏≠
    if (stock && stock.qty > 0) {
      item.qty++;
      stock.qty--;
    }
  } else {
    // ‡∏•‡∏î - ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ stock
    if (item.qty > 0) {
      item.qty--;
      if (stock) stock.qty++;
    }
  }
  
  editItems = editItems.filter(x => x.qty > 0);
  save();
  renderEdit();
}

function removeEditItem(itemName) {
  const item = editItems.find(x => x.name === itemName);
  if (!item) return;
  
  const stock = items.find(x => x.name === itemName);
  if (stock) stock.qty += item.qty;
  
  editItems = editItems.filter(x => x.name !== itemName);
  save();
  renderEdit();
}

function addEditItemByQty(stockIdx) {
  const input = document.getElementById('editAddQty_' + stockIdx);
  let qty = Number(input.value) || 1;
  if (qty <= 0) qty = 1;
  if (qty > items[stockIdx].qty) qty = items[stockIdx].qty;
  if (items[stockIdx].qty <= 0) return;

  items[stockIdx].qty -= qty;
  const existing = editItems.find(x => x.name === items[stockIdx].name);
  existing ? existing.qty += qty : editItems.push({ name: items[stockIdx].name, qty: qty });

  input.value = '';
  save();
  renderEdit();
}

function saveEdit() {
  if (!editItems.length) {
    alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }

  const price = Number(document.getElementById('editBillPrice').value) || 0;
  const deposit = (editPayType === 'deposit') ? (Number(document.getElementById('editDepositAmt').value) || 0) : 0;

  bills[editingBillIndex] = {
    ...bills[editingBillIndex],
    billName: document.getElementById('editBillName').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    date: document.getElementById('editBillDate').value,
    price: price,
    payType: editPayType,
    deposit: deposit,
    remaining: (editPayType === 'deposit') ? Math.max(price - deposit, 0) : (editPayType === 'paid' ? 0 : price),
    status: editPayType === 'paid' ? 'paid' : 'pending',
    items: JSON.parse(JSON.stringify(editItems))
  };

  save();
  cancelEdit();
  render();
  showPage('bill');
}

function cancelEdit() {
  // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ stock (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  const originalBill = bills[editingBillIndex];
  if (originalBill) {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á
    originalBill.items.forEach(orig => {
      const current = editItems.find(x => x.name === orig.name);
      const diff = orig.qty - (current ? current.qty : 0);
      if (diff > 0) {
        const stock = items.find(x => x.name === orig.name);
        if (stock) stock.qty += diff;
      } else if (diff < 0) {
        const stock = items.find(x => x.name === orig.name);
        if (stock) stock.qty += diff; // diff ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      }
    });
    
    // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    editItems.forEach(edit => {
      const inOrig = originalBill.items.find(x => x.name === edit.name);
      if (!inOrig) {
        const stock = items.find(x => x.name === edit.name);
        if (stock) stock.qty += edit.qty;
      }
    });
  }

  editingBillIndex = null;
  editItems = [];
  editPayType = 'pending';
  save();
  render();
  showPage('bill');
}

function renderEdit() {
  if (editingBillIndex === null) return;

  // Items in bill
  const itemCount = editItems.reduce((s, i) => s + i.qty, 0);
  document.getElementById('editItemCount').textContent = itemCount;
  
  document.getElementById('editItemsList').innerHTML = editItems.length
    ? editItems.map((item, idx) => `
        <div class="edit-item" style="animation-delay:${idx*.04}s">
          <div class="item-left">
            <div class="item-icon">‚úèÔ∏è</div>
            <div>
              <div class="item-name">${item.name}</div>
            </div>
          </div>
          <div class="edit-controls">
            <button onclick="editItemQtyChange('${item.name}', -1)">‚àí</button>
            <span class="qty-val">${item.qty}</span>
            <button onclick="editItemQtyChange('${item.name}', 1)">+</button>
            <button class="remove-edit-item" onclick="removeEditItem('${item.name}')">üóë</button>
          </div>
        </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">üì¶</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</div>`;

  // Available stock to add
  const grouped = {};
  items.forEach((it, i) => {
    const key = it.category || '';
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push({ ...it, idx: i });
  });
  const cats = [...new Set(items.map(i => i.category).filter(Boolean))].sort();
  const sortedKeys = cats.concat(grouped[''] ? [''] : []);

  let stockHTML = '';
  sortedKeys.forEach(key => {
    const group = grouped[key];
    if (!group) return;
    const label = key || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    stockHTML += `
      <div class="cat-section-title">
        <span class="cat-label">${label}</span>
        <span class="cat-line"></span>
        <span class="cat-count">${group.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>`;
    stockHTML += group.map((it, ri) => `
      <div class="stock-item" style="animation-delay:${ri*.04}s">
        <div class="item-left">
          <div class="item-icon" style="background:var(--success-lo);color:var(--success);">üìå</div>
          <div>
            <div class="item-name">${it.name}</div>
            <div class="item-qty">${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          </div>
        </div>
        <div class="out-qty-wrap">
          <input type="number" min="1" max="${it.qty}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="out-qty-input" id="editAddQty_${it.idx}" onkeydown="if(event.key==='Enter') addEditItemByQty(${it.idx})">
          <button class="add-out-btn" onclick="addEditItemByQty(${it.idx})">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>`).join('');
  });

  document.getElementById('editAddStock').innerHTML = stockHTML || `<div class="empty-state"><div class="empty-icon">üì¶</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>`;

  // Deposit remaining
  const totalPrice = Number(document.getElementById('editBillPrice').value) || 0;
  const depAmt = Number(document.getElementById('editDepositAmt').value) || 0;
  const rem = Math.max(totalPrice - depAmt, 0);
  document.getElementById('editDepRemaining').textContent = '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + rem.toLocaleString();
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ
function render() {
  // ‚îÄ‚îÄ Stock list (grouped by category) ‚îÄ‚îÄ
  document.getElementById('stockCount').textContent = items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';

  const cats = [...new Set(items.map(i => i.category).filter(Boolean))].sort();
  document.getElementById('catList').innerHTML = cats.map(c => `<option value="${c}">`).join('');

  const grouped = {};
  items.forEach((it, i) => {
    const key = it.category || '';
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push({ ...it, idx: i });
  });

  const sortedKeys = cats.concat(grouped[''] ? [''] : []);

  let stockHTML = '';
  sortedKeys.forEach(key => {
    const group = grouped[key];
    if (!group) return;
    const label = key || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    stockHTML += `
      <div class="cat-section-title">
        <span class="cat-label">${label}</span>
        <span class="cat-line"></span>
        <span class="cat-count">${group.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>`;
    stockHTML += group.map((it, ri) => `
      <div class="stock-item" style="animation-delay:${ri*.04}s">
        <div class="item-left">
          <div class="item-icon">üì¶</div>
          <div>
            <div class="item-name">${it.name}</div>
            <div class="item-qty">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
          </div>
        </div>
        <div class="controls">
          <button onclick="items[${it.idx}].qty--; save(); render();" title="‡∏•‡∏î">‚àí</button>
          <span class="qty-val">${it.qty}</span>
          <button onclick="items[${it.idx}].qty++; save(); render();" title="‡πÄ‡∏û‡∏¥‡πà‡∏°">+</button>
          <button class="del-btn" onclick="deleteItem(${it.idx})" title="‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">üóë</button>
        </div>
      </div>`).join('');
  });

  document.getElementById('stockList').innerHTML = stockHTML || `<div class="empty-state"><div class="empty-icon">üì¶</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;

  // ‚îÄ‚îÄ Out ‚Äî stock selector (grouped by category) ‚îÄ‚îÄ
  const outGrouped = {};
  items.forEach((it, i) => {
    const key = it.category || '';
    if (!outGrouped[key]) outGrouped[key] = [];
    outGrouped[key].push({ ...it, idx: i });
  });
  const outCats = [...new Set(items.map(i => i.category).filter(Boolean))].sort();
  const outSortedKeys = outCats.concat(outGrouped[''] ? [''] : []);

  let outStockHTML = '';
  outSortedKeys.forEach(key => {
    const group = outGrouped[key];
    if (!group) return;
    const label = key || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    outStockHTML += `
      <div class="cat-section-title">
        <span class="cat-label">${label}</span>
        <span class="cat-line"></span>
        <span class="cat-count">${group.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>`;
    outStockHTML += group.map((it, ri) => `
      <div class="stock-item" style="animation-delay:${ri*.04}s">
        <div class="item-left">
          <div class="item-icon" style="background:var(--accent-lo);color:var(--accent);">üìå</div>
          <div>
            <div class="item-name">${it.name}</div>
            <div class="item-qty">${it.qty} ‡∏ä‡∏¥‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          </div>
        </div>
        <div class="out-qty-wrap">
          <input type="number" min="1" max="${it.qty}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="out-qty-input" id="outQty_${it.idx}" onkeydown="if(event.key==='Enter') addOutByQty(${it.idx})">
          <button class="add-out-btn" onclick="addOutByQty(${it.idx})">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>`).join('');
  });

  document.getElementById('outStock').innerHTML = outStockHTML || `<div class="empty-state"><div class="empty-icon">üì¶</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;

  // ‚îÄ‚îÄ Out ‚Äî bill items ‚îÄ‚îÄ
  const outTotal = outItems.reduce((s, o) => s + o.qty, 0);
  document.getElementById('outCount').textContent = outTotal;
  document.getElementById('outBill').innerHTML = outItems.length
    ? outItems.map((b, i) => `
        <div class="stock-item" style="animation-delay:${i*.04}s">
          <div class="item-left">
            <div class="item-icon" style="background:var(--success-lo);color:var(--success);">‚úì</div>
            <div>
              <div class="item-name">${b.name}</div>
              <div class="item-qty">√ó ${b.qty} ‡∏ä‡∏¥‡πâ‡∏ô</div>
            </div>
          </div>
          <button class="remove-out-btn" onclick="removeOut(${i})">‚àí</button>
        </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">üßæ</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</div>`;

  // ‚îÄ‚îÄ Deposit remaining preview ‚îÄ‚îÄ
  const totalPrice = Number(document.getElementById('billPrice').value) || 0;
  const depAmt = Number(document.getElementById('depositAmt').value) || 0;
  const rem = Math.max(totalPrice - depAmt, 0);
  document.getElementById('depRemaining').textContent = '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + rem.toLocaleString();

  // ‚îÄ‚îÄ Bills ‚Äî filter counts ‚îÄ‚îÄ
  const cAll = bills.length;
  const cPending = bills.filter(b => b.status === 'pending' && b.payType === 'pending').length;
  const cDeposit = bills.filter(b => b.payType === 'deposit' && b.status === 'pending').length;
  const cPaid   = bills.filter(b => b.status === 'paid').length;

  document.getElementById('fc-all').textContent     = cAll;
  document.getElementById('fc-pending').textContent = cPending;
  document.getElementById('fc-deposit').textContent = cDeposit;
  document.getElementById('fc-paid').textContent    = cPaid;

  // ‚îÄ‚îÄ show/hide ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î row ‚îÄ‚îÄ
  const paidCount = bills.filter(b => b.status === 'paid').length;
  const showClear = (billFilter === 'paid' && paidCount > 0);
  document.getElementById('clearPaidRow').style.display = showClear ? 'block' : 'none';
  document.getElementById('clearPaidCount').textContent = paidCount + ' ‡∏ö‡∏¥‡∏•';

  // ‚îÄ‚îÄ filter logic ‚îÄ‚îÄ
  let filtered = bills.map((b, i) => ({ ...b, idx: i }));

  if (billFilter === 'pending')  filtered = filtered.filter(b => b.status === 'pending' && b.payType === 'pending');
  if (billFilter === 'deposit')  filtered = filtered.filter(b => b.payType === 'deposit' && b.status === 'pending');
  if (billFilter === 'paid')     filtered = filtered.filter(b => b.status === 'paid');

  // ‚îÄ‚îÄ render list ‚îÄ‚îÄ
  document.getElementById('billList').innerHTML = filtered.length
    ? filtered.map((b, ri) => `
        <div class="bill-card" style="animation-delay:${ri*.05}s; ${b.status === 'paid' ? 'opacity:.65;' : ''}">
          <div class="bill-header">
            <div>
              <div class="bill-name">${b.billName}</div>
              <div class="bill-meta">${b.date}</div>
            </div>
            ${getBadgeHTML(b)}
          </div>
          <div class="bill-items-list">
            ${b.items.map(it => `<span class="tag">${it.name} √ó${it.qty}</span>`).join('')}
          </div>
          <div class="bill-price">
            ${b.price.toLocaleString()} <span>‡∏ö‡∏≤‡∏ó</span>
            ${b.payType === 'deposit'
              ? `<span style="margin-left:10px;font-size:12px;color:${b.status==='paid'?'var(--text-3)':'var(--warning)'};font-family:'Kanit';font-weight:500;">
                  ‡∏°‡∏±‡∏î‡∏à‡∏≥ ${b.deposit.toLocaleString()} ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <strong>${b.remaining.toLocaleString()}</strong>
                </span>` : ''}
          </div>
          ${b.status === 'pending' ? `
            <div class="bill-actions">
              <button class="main secondary" onclick="generatePDF(${b.idx})"><i class="fas fa-file-pdf"></i> ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</button>
              <button class="main" onclick="startEdit(${b.idx})" style="background:linear-gradient(135deg,var(--warning),#fcd34d);color:#78350f;"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
            <div class="bill-actions" style="margin-top:8px;">
              <button class="main success" onclick="markPaid(${b.idx})"><i class="fas fa-check"></i> ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
              <button class="main danger"  onclick="clearBill(${b.idx})"><i class="fas fa-trash"></i> ‡∏•‡∏ö</button>
            </div>` : `
            <div class="bill-actions">
              <button class="main secondary" onclick="generatePDF(${b.idx})"><i class="fas fa-file-pdf"></i> ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</button>
              <button class="main danger" onclick="deletePaidBill(${b.idx})"><i class="fas fa-trash"></i> ‡∏•‡∏ö‡∏ö‡∏¥‡∏•</button>
            </div>`}
        </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">üìã</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</div>`;

  renderRecall();
}

// ‚îÄ‚îÄ‚îÄ Preview & Edit before PDF ‚îÄ‚îÄ‚îÄ
let previewBillIndex = null;

function generatePDF(i) {
  previewBillIndex = i;
  renderPreview();
  showPage('preview');
}

function printPDF() {
  if (previewBillIndex === null) return;
  
  const b = bills[previewBillIndex];
  const dateClean = (b.date || '').replace(/-/g, '');
  const billNo = 'QT' + dateClean + String(previewBillIndex + 1).padStart(4, '0');
  const subtotal = b.price;
  const grandTotal = b.payType === 'deposit' ? b.remaining : subtotal;

  let rowsHTML = '';
  b.items.forEach((it, idx) => {
    rowsHTML += '<tr style="' + (idx % 2 === 1 ? 'background:#f9fafb;' : '') + '">'
      + '<td style="text-align:center;">' + (idx + 1) + '</td>'
      + '<td>' + it.name + '</td>'
      + '<td style="text-align:right;">' + it.qty + ' Q</td>'
      + '<td style="text-align:right;">-</td>'
      + '<td style="text-align:right;">-</td>'
      + '</tr>';
  });

  let totalsHTML = '<tr>'
    + '<td colspan="3"></td>'
    + '<td style="text-align:right;color:#6b7280;font-weight:600;padding-top:10px;">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td>'
    + '<td style="text-align:right;padding-top:10px;">' + subtotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó</td>'
    + '</tr>';
  if (b.payType === 'deposit') {
    totalsHTML += '<tr><td colspan="3"></td>'
      + '<td style="text-align:right;color:#6b7280;font-weight:600;">‡∏°‡∏±‡∏î‡∏à‡∏≥</td>'
      + '<td style="text-align:right;">' + b.deposit.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó</td></tr>'
      + '<tr><td colspan="3"></td>'
      + '<td style="text-align:right;color:#6b7280;font-weight:600;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td>'
      + '<td style="text-align:right;">' + b.remaining.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó</td></tr>';
  }

  const html = '<!DOCTYPE html><html lang="th"><head>'
    + '<meta charset="UTF-8">'
    + '<title>BIGBALL ' + billNo + '</title>'
    + '<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">'
    + '<style>'
    + '* { margin:0; padding:0; box-sizing:border-box; }'
    + 'body { font-family:"Kanit",sans-serif; color:#1f2937; padding:40px 48px; background:#fff; }'
    + '@media print { body { padding:28px 40px; } @page { size:A4; margin:0; } }'
    + '.page { position:relative; width:100%; }'
    + '.corner { position:absolute; top:0; right:0; width:0; height:0; border-style:solid; border-width:0 70px 70px 0; border-color:transparent #f59e0b transparent transparent; }'
    + '.header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:28px; }'
    + '.logo-big { font-size:22px; font-weight:700; color:#1f2937; line-height:1.1; }'
    + '.logo-small { font-size:26px; font-weight:700; color:#1f2937; }'
    + '.logo-line { width:58px; height:3px; background:#f59e0b; margin-top:4px; }'
    + '.title { font-size:22px; font-weight:700; color:#d97706; text-align:right; }'
    + '.info-row { display:flex; justify-content:space-between; margin-bottom:16px; }'
    + '.info-left { font-size:11px; color:#6b7280; line-height:1.7; }'
    + '.seller-name { font-size:12px; font-weight:600; color:#1f2937; }'
    + '.info-right { display:flex; flex-direction:column; gap:3px; }'
    + '.ir-row { display:flex; gap:14px; font-size:11px; }'
    + '.ir-label { color:#d97706; font-weight:600; min-width:42px; }'
    + '.ir-val { color:#1f2937; }'
    + 'hr.sep { border:none; border-top:1px solid #e5e7eb; margin:14px 0; }'
    + '.cust-label { font-size:12px; font-weight:700; color:#d97706; margin-bottom:3px; }'
    + '.cust-name { font-size:12px; color:#1f2937; margin-bottom:18px; }'
    + 'table { width:100%; border-collapse:collapse; font-size:11px; }'
    + 'th { background:#f3f4f6; font-weight:600; color:#1f2937; padding:7px 10px; border-top:1px solid #d1d5db; border-bottom:1px solid #d1d5db; text-align:left; font-size:10px; }'
    + 'th:nth-child(n+3) { text-align:right; }'
    + 'td { padding:6px 10px; border-bottom:1px solid #eee; }'
    + 'hr.total-sep { border:none; border-top:1px solid #e5e7eb; margin:10px 0 4px; }'
    + '.grand-row td { font-size:12px; font-weight:700; color:#d97706; padding-top:8px; }'
    + '.grand-row td:last-child { color:#1f2937; }'
    + '</style></head><body><div class="page">'
    + '<div class="corner"></div>'
    + '<div class="header">'
    + '<div><div class="logo-big">Big</div><div class="logo-small">Ball</div><div class="logo-line"></div></div>'
    + '<div class="title">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>'
    + '</div>'
    + '<div class="info-row">'
    + '<div class="info-left"><div class="seller-name">BIGBALL</div>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó BIGBALL ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>'
    + '<div class="info-right">'
    + '<div class="ir-row"><span class="ir-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</span><span class="ir-val">' + billNo + '</span></div>'
    + '<div class="ir-row"><span class="ir-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span class="ir-val">' + (b.date || '-') + '</span></div>'
    + '<div class="ir-row"><span class="ir-label">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span><span class="ir-val">30 ‡∏ß‡∏±‡∏ô</span></div>'
    + '</div></div>'
    + '<hr class="sep">'
    + '<div class="cust-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>'
    + '<div class="cust-name">' + b.billName + '</div>'
    + '<table><thead><tr>'
    + '<th style="width:40px;">#</th>'
    + '<th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>'
    + '<th style="width:60px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>'
    + '<th style="width:70px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>'
    + '<th style="width:80px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>'
    + '</tr></thead><tbody>'
    + rowsHTML
    + totalsHTML
    + '</tbody></table>'
    + '<hr class="total-sep">'
    + '<table><tr class="grand-row">'
    + '<td colspan="3"></td>'
    + '<td style="text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td>'
    + '<td style="text-align:right;">' + grandTotal.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó</td>'
    + '</tr></table>'
    + '</div></body></html>';

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 600);
}

function editBeforePrint() {
  if (previewBillIndex === null) return;
  startEdit(previewBillIndex);
  previewBillIndex = null;
}

function cancelPreview() {
  previewBillIndex = null;
  showPage('bill');
}

function renderPreview() {
  if (previewBillIndex === null) return;
  
  const b = bills[previewBillIndex];
  const dateClean = (b.date || '').replace(/-/g, '');
  const billNo = 'QT' + dateClean + String(previewBillIndex + 1).padStart(4, '0');
  const subtotal = b.price;
  const grandTotal = b.payType === 'deposit' ? b.remaining : subtotal;

  let itemsHTML = '';
  b.items.forEach((it, idx) => {
    itemsHTML += `
      <div class="preview-item">
        <span class="pi-num">${idx + 1}</span>
        <span class="pi-name">${it.name}</span>
        <span class="pi-qty">${it.qty} Q</span>
      </div>`;
  });

  let totalsHTML = `
    <div class="preview-total-row">
      <span class="pt-label">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
      <span class="pt-value">${subtotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
    </div>`;
  
  if (b.payType === 'deposit') {
    totalsHTML += `
      <div class="preview-total-row sub">
        <span class="pt-label">‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
        <span class="pt-value">${b.deposit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </div>
      <div class="preview-total-row sub">
        <span class="pt-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
        <span class="pt-value">${b.remaining.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </div>`;
  }

  document.getElementById('previewContent').innerHTML = `
    <div class="preview-header">
      <div class="ph-left">
        <div class="ph-logo">Big<br><span style="font-size:26px;">Ball</span></div>
        <div class="ph-company">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó BIGBALL ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
      </div>
      <div class="ph-right">
        <div class="ph-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
        <div class="ph-info">
          <div class="phi-row"><span>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span> <strong>${billNo}</strong></div>
          <div class="phi-row"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> <strong>${b.date || '-'}</strong></div>
          <div class="phi-row"><span>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï:</span> <strong>30 ‡∏ß‡∏±‡∏ô</strong></div>
        </div>
      </div>
    </div>
    
    <div class="preview-customer">
      <div class="pc-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="pc-name">${b.billName}</div>
    </div>

    <div class="preview-items">
      <div class="preview-item-header">
        <span style="width:40px;">#</span>
        <span style="flex:1;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
        <span style="width:80px;text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
      </div>
      ${itemsHTML}
    </div>

    <div class="preview-totals">
      ${totalsHTML}
      <div class="preview-grand">
        <span class="pg-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
        <span class="pg-value">${grandTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </div>
    </div>
  `;
}

autoCleanup();
render();
renderRecall();
</script>

</body>
</html>
